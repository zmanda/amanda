#! /bin/sh

# cd to the directory we're run from
cd `dirname $0`

# if you change this, please also change it in the root Makefile.am
includes="-I . -I config -I config/gettext-macros -I config/gnulib -I config/amanda -I config/macro-archive -I /usr/share/aclocal"

# clean up
rm -f aclocal.m4
rm -rf autom4te*.cache
rm -f configure

die() {
    echo x"${@}" | sed 's/^x//'
    exit 1
}

echo "See DEVELOPING for instructions on updating:"
echo " * gettext macros"
echo " * gnulib"
echo " * libtool files"

echo "..creating file lists"
(   cd config
    for m4dir in amanda gettext-macros gnulib macro-archive; do
	echo "## this file is automatically generated by autogen" > "$m4dir/file-list"
	for f in $m4dir/*.m4; do echo "EXTRA_DIST += $f" >> "$m4dir/file-list"; done
    done

    echo "## this file is automatically generated by autogen" > "automake/file-list"
    for f in automake/*.am; do echo "EXTRA_DIST += $f" >> "automake/file-list"; done
)

#set the FULL_VERSION file
config/set_full_version

# replace local tools with the custom versions
command -v libtoolize >/dev/null && libtoolize -i --force

# need 2.63 or later autoconf/autom4te
AUTOM4TE="$(ls -1 /usr/bin/autom4te2[6789]* /usr/bin/autom4te[3-9]* 2>/dev/null)"
# last space-separated word only..
AUTOM4TE=${AUTOM4TE##* }
AUTOM4TE=${AUTOM4TE##*\n}
# suffix numbers only
AC_VERSION_SFX="${AUTOM4TE##*autom4te}"

export AUTOM4TE="autom4te${AC_VERSION_SFX}"
export AUTOCONF="autoconf${AC_VERSION_SFX}"

echo "..aclocal with version $AC_VERSION_SFX"
aclocal --install $includes || die "aclocal failed"

echo "...aclocal patches"
# See http://bugzilla.gnome.org/show_bug.cgi?id=418778
#
# The Glib developers are a bit over-eager in their version requirements, requiring
# an unnecessarily high verison of pkg-config at configure time, when they really
# only need it at autogen time.  This patch resets the version number in the file
# just generated by aclocal to the version we've been requiring all along.
sed -e  \
     's/PKG_PROG_PKG_CONFIG(\[0\.16\])/PKG_PROG_PKG_CONFIG([0.7])/g' \
     aclocal.m4 > aclocal.m4~ && mv aclocal.m4~ aclocal.m4

echo "..autoconf with version $AC_VERSION_SFX"
autoconf${AC_VERSION_SFX} || die "autoconf failed"

echo "..autoheader with version $AC_VERSION_SFX"
autoheader${AC_VERSION_SFX} || die "autoheader failed"
touch config/config.h.in

echo "..automake"
automake --add-missing --force --copy --warnings=none || die "automake failed"
